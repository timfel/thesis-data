<html>
        <head>
        <title>Babelsberg/JS Tests</title>
        <script src="../repositories/babelsberg-js-jit/standalone/prototype.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/minilively.js"></script>

        <!-- // cop.Layers -->
        <script src="../repositories/babelsberg-js-jit/standalone/../cop/Layers.js"></script>

        <!-- // ometa.lively -->
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/lib.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/ometa-base.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/parser.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/ChunkParser.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/bs-ometa-compiler.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/bs-js-compiler.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/bs-ometa-js-compiler.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/bs-ometa-optimizer.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/lk-parser-extensions.js"></script>
        <!-- // lively.Ometa -->
        <script src="../repositories/babelsberg-js-jit/standalone/../ometa/Ometa.js"></script>
        <!-- // lively.Interpreter -->
        <script src="../repositories/babelsberg-js-jit/standalone/../jsinterpreter/generated/Nodes.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../jsinterpreter/generated/Translator.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../jsinterpreter/LivelyJSParser.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../jsinterpreter/Parser.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../jsinterpreter/Meta.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../jsinterpreter/Rewriting.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../jsinterpreter/Interpreter.js"></script>
        <!-- // Cassowary -->
        <script src="../repositories/babelsberg-js-jit/standalone/../cassowary/Hashtable.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../cassowary/HashSet.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../cassowary/DwarfCassowary.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/cassowary_ext.js"></script>
        <!-- // DeltaBlue -->
        <script src="../repositories/babelsberg-js-jit/standalone/../deltablue/deltablue.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/deltablue_ext.js"></script>
        <!-- // CSP -->
        <script src="../repositories/babelsberg-js-jit/standalone/../csp/underscore-min.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../csp/csp.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/csp_ext.js"></script>
        <!-- // Babelsberg/js -->
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/core_ext.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/constraintinterpreter.js"></script>
        <!-- // Relax -->
        <script src="../repositories/babelsberg-js-jit/standalone/../sutherland/relax.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../sutherland/relax_bbb.js"></script>
        <!-- // reactive: assert, trigger, layer.activeOn, layer.always, ... -->
        <script src="../repositories/babelsberg-js-jit/standalone/../reactive/reactive.js"></script>
        <!-- // Tests -->
        <script src="../repositories/babelsberg-js-jit/standalone/test_harness.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../reactive/reactive_test.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/tests.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/src_transform_test.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ohshima/ElectricalComponents.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ohshima/ElectricalComponentsTests.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../ohshima/ElectricalCircuitTests.js"></script>
        <!-- // src transform -->
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/uglify.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../babelsberg/src_transform.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/babelsbergscript.js"></script>
        <!-- // BackTalk -->
        <script src="../repositories/babelsberg-js-jit/standalone/../backtalk/backtalk.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../backtalk/constraints.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../backtalk/backtalk_ext.js"></script>
        <script src="../repositories/babelsberg-js-jit/standalone/../backtalk/tests.js"></script>
        <script src="../repositories/babelsberg-js-jit/babelsberg/editconstraintjit.js"></script>
        <script src="benchmark.js"></script>

        <script type="text/babelsbergscript">
	lively.lang = lively.lang || {};
	lively.lang.string = lively.lang.string || {};
	lively.lang.string.pad = lively.lang.string.pad || function(string, n, left) {
	    n = n || 1;
            return left ? ' '.times(n) + string : string + ' '.times(n);
        }
	// lively.lang.string.pad = function(string, n) { return string };
	console.assert = function() { return true; };
	(new ECJITTests()).benchAll()
        </script>

	<script type="text/babelsbergscript">
	var suite = new Benchmark.Suite;

	var Iterations = 1000
	suite.add('Imperative Drag Simulation', function() {
	var mouse = {},
	mercury = {},
	thermometer = {},
	temperature = 0,
	gray = {},
	white = {},
	display = {};

	for (var i = 0; i < 100; i++) {
	    mouse.location_y = i
	    var old = mercury.top
	    mercury.top = mouse.location_y
	    if (mercury.top > thermometer.top) {
	       mercury.top = thermometer.top
	    }
	    temperature = mercury.top
	    if (old < mercury.top) {
	       // moves upwards (draws over the white)
	       gray.top = mercury.top
	    } else {
	       // moves downwards (draws over the gray)
	       white.bottom = mercury.top
	    }
	    display.number = temperature
	}
}).add('Declarative Drag Simulation (Classic Jit)', function() {
var ctx = {
mouse: {location_y: 0},
mercury: {top: 0, bottom: 0},
thermometer: {top: 0, bottom: 0},
temperature: {c: 0},
gray: {top: 0, bottom: 0},
white: {top: 0, bottom: 0},
display: {number: 0}},
solver = new ClSimplexSolver();
solver.setAutosolve(false);
solver.ecjit = new ClassicECJIT();

bbb.always({solver: solver, ctx: ctx}, function () { return temperature.c == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.top == thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.bottom == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.top == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.bottom == mercury.bottom });
bbb.always({solver: solver, ctx: ctx}, function () { return display.number == temperature.c });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top == mouse.location_y });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top <= thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.bottom == thermometer.bottom });

for (var i = 0; i < 100; i++) {
ctx.mouse.location_y = i
}
}).add('Declarative Drag Simulation (Additive JIT)', function() {
var ctx = {
mouse: {location_y: 0},
mercury: {top: 0, bottom: 0},
thermometer: {top: 0, bottom: 0},
temperature: {c: 0},
gray: {top: 0, bottom: 0},
white: {top: 0, bottom: 0},
display: {number: 0}},
solver = new ClSimplexSolver();
solver.setAutosolve(false);
solver.ecjit = new AdditiveAdaptiveECJIT();

bbb.always({solver: solver, ctx: ctx}, function () { return temperature.c == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.top == thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.bottom == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.top == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.bottom == mercury.bottom });
bbb.always({solver: solver, ctx: ctx}, function () { return display.number == temperature.c });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top == mouse.location_y });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top <= thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.bottom == thermometer.bottom });

for (var i = 0; i < 100; i++) {
ctx.mouse.location_y = i
}
}).add('Declarative Drag Simulation (Multiplactive Jit)', function() {
var ctx = {
mouse: {location_y: 0},
mercury: {top: 0, bottom: 0},
thermometer: {top: 0, bottom: 0},
temperature: {c: 0},
gray: {top: 0, bottom: 0},
white: {top: 0, bottom: 0},
display: {number: 0}},
solver = new ClSimplexSolver();
solver.setAutosolve(false);
solver.ecjit = new MultiplicativeAdaptiveECJIT();

bbb.always({solver: solver, ctx: ctx}, function () { return temperature.c == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.top == thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.bottom == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.top == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.bottom == mercury.bottom });
bbb.always({solver: solver, ctx: ctx}, function () { return display.number == temperature.c });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top == mouse.location_y });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top <= thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.bottom == thermometer.bottom });

for (var i = 0; i < 100; i++) {
ctx.mouse.location_y = i
}
}).add('Declarative Drag Simulation (Last JIT)', function() {
var ctx = {
mouse: {location_y: 0},
mercury: {top: 0, bottom: 0},
thermometer: {top: 0, bottom: 0},
temperature: {c: 0},
gray: {top: 0, bottom: 0},
white: {top: 0, bottom: 0},
display: {number: 0}},
solver = new ClSimplexSolver();
solver.setAutosolve(false);
solver.ecjit = new LastECJIT();

bbb.always({solver: solver, ctx: ctx}, function () { return temperature.c == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.top == thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.bottom == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.top == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.bottom == mercury.bottom });
bbb.always({solver: solver, ctx: ctx}, function () { return display.number == temperature.c });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top == mouse.location_y });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top <= thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.bottom == thermometer.bottom });

for (var i = 0; i < 100; i++) {
ctx.mouse.location_y = i
}
}).add('Edit Drag Simulation', function() {
var ctx = {
mouse: {location_y: 0},
mercury: {top: 0, bottom: 0},
thermometer: {top: 0, bottom: 0},
temperature: {c: 0},
gray: {top: 0, bottom: 0},
white: {top: 0, bottom: 0},
display: {number: 0}};
var solver = new ClSimplexSolver();

bbb.always({solver: solver, ctx: ctx}, function () { return temperature.c == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.top == thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return white.bottom == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.top == mercury.top });
bbb.always({solver: solver, ctx: ctx}, function () { return gray.bottom == mercury.bottom });
bbb.always({solver: solver, ctx: ctx}, function () { return display.number == temperature.c });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top == mouse.location_y });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.top <= thermometer.top });
bbb.always({solver: solver, ctx: ctx}, function () { return mercury.bottom == thermometer.bottom });

var cb = bbb.edit(ctx.mouse, ["location_y"]);
for (var i = 0; i < this.Iterations; i++) {
cb(i);
}
})

['clAddSim', 'dbAddSim', 'clDragSim', 'clDrag2DSim', 'clDrag2DSimFastX', 'clDrag2DSimChangeHalf', 'clDrag2DSimChangeTenth', 'clDrag2DSimFreqChange5'].forEach(function (bench) {
    ['EmptyECJIT', 'ClassicECJIT', 'AdditiveAdaptiveECJIT', 'MultiplicativeAdaptiveECJIT', 'LastECJIT'].forEach(function(jit) {
        suite.add(bench + " with " + jit, function() {
	    (new ECJITTests())[bench](100, new eval(jit));
	});
    });
});


suite.on('cycle', function(event) {
console.log(String(event.target));
}).on('complete', function() {
console.log('Fastest is ' + this.filter('fastest').pluck('name'));
}).run({ 'async': false });

	</script>

        </head>
        <body>
        </body>
</html>
